<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Kendaraan</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <!-- LOGIN -->
  <div id="loginPage">
    <h2>Login Admin</h2>
    <form id="loginForm">
      <div class="form-group"><label>Email</label><input type="text" name="username" required></div>
      <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardPage" class="hidden">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h2>Dashboard</h2>
    <div class="dashboard-menu">
      <button class="card-btn" onclick="showNewBookingForm()">Booking Kendaraan</button>
      <button class="card-btn" onclick="showPage('dataPage')">Data Booking</button>
      <button class="card-btn" onclick="showPage('rekapPage')">Rekap Show/No Show/Reschedule</button>
      <button class="card-btn" onclick="showPage('rekapSalesPage')">Rekap Sales</button>
      <button class="card-btn" onclick="showPage('mrsPage')">MRS (Maintenance Reminder System)</button>  
    </div>
  </div>

  <!-- FORM BOOKING -->
  <div id="bookingPage" class="hidden">
    <button onclick="showPage('dashboardPage')">Kembali</button>
    <h3>Form Booking</h3>
    <form id="bookingForm">
      <input type="hidden" name="editId" id="editId" />
      <input type="hidden" name="sheetName" id="sheetName" />
      <div class="form-group"><label>Nomor Polisi</label><input type="text" name="plat" required /></div>
      <div class="form-group hidden" id="statusGroup">
        <label>Status Kehadiran</label>
        <select name="status_kehadiran" id="status_kehadiran_select">
          <option value="show">show</option>
          <option value="no show">no show</option>
          <option value="reschedule">reschedule</option>
        </select>
      </div>
      <div class="form-group"><label>Tipe Kendaraan</label><input type="text" name="tipe" required /></div>
      <div class="form-group"><label>Tahun</label><input type="text" name="tahun" required /></div>
      <div class="form-group">
        <label>Tipe Telepon</label>
        <select name="tipe_telepon" id="tipe_telepon" required onchange="togglePhoneInput()">
          <option value="">Pilih Tipe Telepon</option>
          <option value="TELP">TELP</option>
          <option value="SA">SA</option>
        </select>
      </div>
      <div class="form-group" id="phoneInputGroup">
        <label>No HP</label>
        <div style="display: flex; align-items: center;">
          <span style="background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-right: none; border-radius: 5px 0 0 5px; color: #666;">62</span>
          <input type="text" name="nohp" id="nohp_input" placeholder="81298292" style="border-radius: 0 5px 5px 0; border-left: none;" required />
        </div>
      </div>
      <div class="form-group" id="saPhoneGroup" style="display: none;">
        <label>SA</label>
        <select name="nohp_sa" id="nohp_sa_select">
          <option value="">Pilih SA</option>
          <option value="DB">DB</option>
          <option value="DM">DM</option>
          <option value="DR">DR</option>
          <option value="PS">PS</option>
          <option value="RZ">RZ</option>
        </select>
      </div>
      <div class="form-group" id="customerDatangGroup">
        <label>Customer Akan Datang</label>
        <input type="text" name="datang" id="datang_input" placeholder="Nama customer yang akan datang" required />
      </div>
      <div class="form-group" id="customerDatangDropdown" style="display: none;">
        <label>Customer Akan Datang</label>
        <select name="datang_dropdown" id="datang_select">
          <option value="">Pilih Customer</option>
          <option value="DB">DB</option>
          <option value="DM">DM</option>
          <option value="DR">DR</option>
          <option value="PS">PS</option>
          <option value="RZ">RZ</option>
        </select>
      </div>
      <div class="form-group"><label>Nama Customer</label><input type="text" name="nama" required /></div>
      <div class="form-group"><label>Tanggal Penerimaan</label><input type="date" name="tanggal_penerimaan" required /></div>
      <div class="form-group"><label>Jam Penerimaan</label><input type="time" name="jam_penerimaan" required /></div>
      <div class="form-group"><label>VIA</label>
        <select name="via" required>
          <option value="AW">AW</option>
          <option value="SA">SA</option>
          <option value="TAB">TAB</option>
          <option value="MRS">MRS</option>
          <option value="TLP">TLP</option>
        </select>
      </div>
      <div class="form-group"><label>Admin</label>
        <select name="admin" required>
          <option value="Frenty">Frenty</option>
          <option value="Risa">Risa</option>
          <option value="AW">AW</option>
        </select>
      </div>
      <div class="form-group"><label>Jenis Pekerjaan</label><textarea name="keluhan" required></textarea></div>
      <div class="form-group"><label>Nama Sales (Opsional)</label>
        <select name="sales" id="sales_select" onchange="toggleOtherSalesBooking()">
          <option value="">Pilih Sales</option>
          <option value="zen">Zen</option>
          <option value="januar">Januar</option>
          <option value="nia">Nia</option>
          <option value="avro">Avro</option>
          <option value="mila">Mila</option>
          <option value="indra">Indra</option>
          <option value="hendra">Hendra</option>
          <option value="irvan">Irvan</option>
          <option value="rony">Rony</option>
          <option value="stevy">Stevy</option>
          <option value="osla">Osla</option>
          <option value="imron">Imron</option>
          <option value="asep aj">Asep AJ</option>
          <option value="nadia">Nadia</option>
          <option value="daulat">Daulat</option>
          <option value="other">Other</option>
        </select>
        <input type="text" name="sales_other" id="sales_other_input" placeholder="Nama Sales Lain" style="display:none;margin-top:4px;" />
      </div>
      <button type="submit" id="submitBtn">Kirim</button>
    </form>
  </div>

  <!-- DATA -->
  <div id="dataPage" class="hidden">
    <button onclick="showPage('dashboardPage')">Kembali</button>
    <h3>Data Booking</h3>
    <div>
      <label>Filter Tanggal: <input type="date" id="filter-date" /></label>
      <button onclick="loadData()">Lihat Data</button>
    </div>
    <div class="table-responsive">
      <table id="dataTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Status</th>
            <th>Plat</th>
            <th>Tipe</th>
            <th>Tahun</th>
            <th>HP</th>
            <th>Datang</th>
            <th>Nama</th>
            <th>Tanggal Booking</th>
            <th>Tanggal Penerimaan</th>
            <th>Jam Penerimaan</th>
            <th>Via</th>
            <th>Admin</th>
            <th>Keluhan</th>
            <th>Sales</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- REKAP -->
  <div id="rekapPage" class="hidden">
    <button onclick="showPage('dashboardPage')">Kembali</button>
    <h3>Rekap Show/No Show/Reschedule</h3>
    <div>
      <label>Filter Tanggal: <input type="date" id="rekap-filter-date" /></label>
      <button onclick="loadRekap()">Lihat Rekap</button>
      <button onclick="exportRekapToSpreadsheet()" id="exportBtn" class="hidden">Export ke Spreadsheet</button>
    </div>
    <div id="rekapSummary" class="hidden">
      <h4>Ringkasan</h4>
      <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Show:</strong> <span id="showCount">0</span>
        </div>
        <div style="background: #ffe8e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>No Show:</strong> <span id="noShowCount">0</span>
        </div>
        <div style="background: #fff3e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Reschedule:</strong> <span id="rescheduleCount">0</span>
        </div>
        <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Total:</strong> <span id="totalCount">0</span>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table id="rekapTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Status</th>
            <th>Plat</th>
            <th>Nama Customer</th>
            <th>Tanggal Penerimaan</th>
            <th>Jam Penerimaan</th>
            <th>Via</th>
            <th>Admin</th>
            <th>Sales</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- REKAP SALES -->
<div id="rekapSalesPage" class="hidden">
  <button onclick="showPage('dashboardPage')">Kembali</button>
  <h3>Rekap Sales</h3>
  <div style="margin: 20px 0;">
    <label>Pilih Bulan: 
      <select id="rekap-sales-month">
        <option value="">Semua Bulan</option>
        <option value="01">Januari</option>
        <option value="02">Februari</option>
        <option value="03">Maret</option>
        <option value="04">April</option>
        <option value="05">Mei</option>
        <option value="06">Juni</option>
        <option value="07">Juli</option>
        <option value="08">Agustus</option>
        <option value="09">September</option>
        <option value="10">Oktober</option>
        <option value="11">November</option>
        <option value="12">Desember</option>
      </select>
    </label>
    <label>Tahun: 
      <input type="number" id="rekap-sales-year" min="2020" max="2100" value="2025" style="width:80px; margin-left:10px;" />
    </label>
    <div style="margin-top: 20px;">
      <button onclick="loadRekapSales()" class="card-btn" style="margin: 10px;">VIEW REKAP</button>
      <button onclick="showPage('infoCustomerPage')" class="card-btn" style="margin: 10px;">VIEW INFO CUSTOMER</button>
      <button onclick="showPage('thsBookingPage')" class="card-btn" style="margin: 10px;">Booking THS</button>
      <button onclick="loadRekapTHS()" class="card-btn" style="margin: 10px;">VIEW REKAP SALES by THS</button>
      <button onclick="showSalesCharts()" class="card-btn" style="margin: 10px;">LIHAT GRAFIK</button>
      <button onclick="updateSalesRekapSpreadsheet()" class="card-btn" style="margin: 10px; background: #28a745;">UPDATE SPREADSHEET</button>
      <button onclick="loadTotalBookingSales()" class="card-btn" style="margin: 10px; background: #007bff; color: white;">
        TOTAL BOOKING SALES
      </button>
    </div>
  </div>
  <div id="rekapSalesTableContainer" class="table-responsive"></div>
  <div id="salesChartsContainer" class="hidden" style="margin-top: 30px;">
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 300px;">
        <h4>Bar Chart - Perbandingan Sales</h4>
        <canvas id="salesBarChart" width="400" height="400"></canvas>
      </div>
    </div>
    <div id="salesSummary" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
      <h4>Ringkasan</h4>
      <div id="salesSummaryContent"></div>
    </div>
  </div>
</div>

<!-- Booking THS -->
<div id="thsBookingPage" class="hidden">
  <button onclick="showPage('rekapSalesPage')">Kembali</button>
  <h3>Input & Kelola Booking THS</h3>

  <!-- Form Input/Edit -->
  <form id="thsBookingForm">
    <input type="hidden" name="edit_id" />

    <label>Nama Sales:
      <select name="nama_sales" required>
        <option value="">-- Pilih Sales --</option>
        <option>Zen</option>
        <option>Nia</option>
        <option>Avro</option>
        <option>Januar</option>
        <option>Mila</option>
        <option>Indra</option>
        <option>Hendra</option>
        <option>Irvan</option>
        <option>Rony</option>
        <option>Stevy</option>
        <option>Osla</option>
        <option>Imron</option>
        <option>Asep AJ</option>
        <option>Nadia</option>
        <option>Daulat</option>
      </select>
    </label><br>

    <label>Tanggal Penerimaan:
      <input type="date" name="tanggal_penerimaan" required>
    </label><br>

    <label>Keterangan:
      <select name="keterangan" required>
        <option value="show">Show</option>
        <option value="noshow">No Show</option>
        <option value="resc">Reschedule</option>
      </select>
    </label><br>

    <label>Quantity:
      <input type="number" name="qty" min="1" value="1" required>
    </label><br>

    <button type="submit">Simpan</button>
  </form>
</div>
  
  <!-- MRS (Monthly Reminder System) -->
  <div id="mrsPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>MRS (Monthly Reminder System)</h3>
    <div style="margin: 20px 0;">
      <button onclick="showPage('mrsInputPage')" class="card-btn" style="margin: 10px;">Input MRS</button>
      <button onclick="showPage('mrsViewPage')" class="card-btn" style="margin: 10px;">View MRS</button>
    </div>
  </div>

  <!-- MRS INPUT -->
  <div id="mrsInputPage" class="hidden">
    <button onclick="showPage('mrsPage')">&larr; Kembali</button>
    <h3>Input MRS</h3>
    <form id="mrsForm">
      <div class="form-group">
        <label>Nomor Polisi</label>
        <input type="text" name="plat_mrs" required />
      </div>
      <div class="form-group">
        <label>Bulan</label>
        <select name="reminder_month" id="reminder_month_select" required>
          <option value="">Pilih Bulan</option>
          <option value="Januari">Januari</option>
          <option value="Februari">Februari</option>
          <option value="Maret">Maret</option>
          <option value="April">April</option>
          <option value="Mei">Mei</option>
          <option value="Juni">Juni</option>
          <option value="Juli">Juli</option>
          <option value="Agustus">Agustus</option>
          <option value="September">September</option>
          <option value="Oktober">Oktober</option>
          <option value="November">November</option>
          <option value="Desember">Desember</option>
        </select>
      </div>
      <div class="form-group">
        <label>CH</label>
        <input type="text" name="ch_mrs" required />
      </div>
      <div class="form-group">
        <label>Nama Customer</label>
        <input type="text" name="nama_customer_mrs" required />
      </div>
      <div class="form-group">
        <label>No HP</label>
        <div style="display: flex; align-items: center;">
          <span style="background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-right: none; border-radius: 5px 0 0 5px; color: #666;">62</span>
          <input type="text" name="nohp_mrs" id="nohp_mrs_input" placeholder="812xxxxxxx" style="border-radius: 0 5px 5px 0; border-left: none;" required />
        </div>
      </div>
      <button type="submit">Simpan MRS</button>
    </form>
  </div>

 <!-- MRS VIEW -->
<div id="mrsViewPage" class="hidden">
  <button onclick="showPage('mrsPage')">&larr; Kembali</button>
  <h3>View MRS</h3>
  <div>
    <label>Filter Bulan:
      <select id="mrs-filter-month"></select>
      <input type="number" id="mrs-filter-year" min="2000" max="2100" placeholder="Tahun" />
    </label>
    <button onclick="loadMRSData()">Tampilkan</button>
  </div>

  <div class="table-responsive">
    <table id="mrsTable" class="hidden">
      <thead>
        <tr>
          <th>No</th>
          <th>Nomor Polisi</th>
          <th>Bulan</th>
          <th>CH</th>
          <th>Nama Customer</th>
          <th>No HP</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- View MRS Per Bulan -->
<div id="mrsViewByMonthPage" class="hidden">
  <button onclick="showPage('mrsPage')">&larr; Kembali</button>
  <h3>View MRS per Bulan</h3>
  <div>
    <label>Bulan:
      <select id="mrs-view-bulan"></select>
    </label>
    <label>Tahun:
      <input type="number" id="mrs-view-tahun" min="2020" max="2100" placeholder="Tahun" />
    </label>
    <button onclick="loadMRSView()">Lihat Data</button>
  </div>

  <div class="table-responsive">
    <table id="mrsViewTable" class="hidden">
      <thead>
        <tr>
          <th>No</th>
          <th>Nomor Polisi</th>
          <th>Bulan</th>
          <th>CH</th>
          <th>Nama Customer</th>
          <th>No HP</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>



 
  <div id="infoCustomerPage" class="hidden">
    <button onclick="showPage('rekapSalesPage')">Kembali</button>
    <h3>Info Customer per Sales</h3>
    <div style="margin: 20px 0;">
      <label>Pilih Sales: <select id="customer-info-sales"></select></label>
      <button onclick="showCustomerInfo()">View</button>
    </div>
    <div id="customerInfoTableContainer"></div>
  </div>

  
  <!-- KEDATANGAN MODAL -->
  <div id="kedatanganModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Update Status Kedatangan</h3>
        <span class="close" onclick="closeKedatanganModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label><strong>Nomor Polisi:</strong> <span id="modal-plat"></span></label>
        </div>
        <div class="form-group">
          <label><strong>Nama Customer:</strong> <span id="modal-nama"></span></label>
        </div>
        <div class="form-group">
          <label>Status Kehadiran:</label>
          <select id="modal-status-kehadiran" required>
            <option value="show">Show</option>
            <option value="no show">No Show</option>
            <option value="reschedule">Reschedule</option>
          </select>
        </div>
        <div class="form-group">
          <label>Catatan (Opsional):</label>
          <textarea id="modal-catatan" placeholder="Tambahkan catatan jika diperlukan"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeKedatanganModal()" class="btn-secondary">Batal</button>
        <button onclick="updateKedatanganStatus()" class="btn-primary">Update Status</button>
      </div>
    </div>
  </div>

 <!-- MRS STATUS MODAL -->
<div id="mrsStatusModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Update Status MRS</h3>
      <span class="close" onclick="closeMRSStatusModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label><strong>Nomor Polisi:</strong> <span id="mrs-modal-plat"></span></label>
      </div>
      <div class="form-group">
        <label><strong>Nama Customer:</strong> <span id="mrs-modal-nama"></span></label>
      </div>
      <div class="form-group">
        <label>Status:</label>
        <select id="mrs-modal-status" required>
          <option value="Sudah Dihubungi">Sudah Dihubungi</option>
          <option value="">Belum Dihubungi</option>
        </select>
      </div>
      <div class="form-group">
        <label>Catatan (Opsional):</label>
        <textarea id="mrs-modal-catatan" placeholder="Tambahkan catatan jika diperlukan"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeMRSStatusModal()" class="btn-secondary">Batal</button>
      <button onclick="updateMRSStatus()" class="btn-primary">Update Status</button>
    </div>
  </div>
</div>


  <div id="loadingIndicator" style="display:none;text-align:center;font-weight:bold;font-size:1.2em;margin:10px 0;">
    <span id="loadingText">MEMPROSES...</span> <span style="font-size:1.5em;">⏳</span>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
const URL = "https://script.google.com/macros/s/AKfycbyM8Dt5kOXsyauhjsr0KF0OIfFBIMfgwidMAwbQv694pBIDOhAvMjEKewC1j8VvJg/exec";

function formatDateOnly(dateStr) {
  if (!dateStr) return "";
  if (dateStr instanceof Date) return dateStr.toISOString().split("T")[0];
  if (typeof dateStr === "string" && dateStr.includes("T")) return dateStr.split("T")[0];
  if (typeof dateStr === "string") return dateStr;
  return "";
}

function formatJam(jamStr) {
  if (!jamStr) return "";
  if (/^\d{1,2}:\d{2}$/.test(jamStr)) return jamStr;
  const date = new Date(jamStr);
  if (isNaN(date.getTime())) return jamStr;
  let hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  return `${hours}:${minutes} ${ampm}`;
}


function formatTanggalOnly(dateStr) {
  if (!dateStr) return '';
  if (dateStr instanceof Date) return dateStr.toISOString().split('T')[0];
  if (typeof dateStr === 'string' && dateStr.includes('T')) return dateStr.split('T')[0];
  if (typeof dateStr === 'string') return dateStr;
  return '';
}

const SALES_LIST = [
  'zen', 'januar', 'nia', 'avro', 'mila', 'indra', 'hendra', 'irvan', 'rony', 'stevy', 'osla', 'imron', 'asep aj', 'nadia', 'daulat', 'other'
];

function getMonthName(monthNumber) {
  const months = [
    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
  ];
  return months[parseInt(monthNumber) - 1];
}

const bulanList = [
  "Januari", "Februari", "Maret", "April", "Mei", "Juni",
  "Juli", "Agustus", "September", "Oktober", "November", "Desember"
];



function isiDropdownBulan(selectId, mode = "angka") {
    const select = document.getElementById(selectId);
    select.innerHTML = "";
    bulanList.forEach((bulan, idx) => {
      const opt = document.createElement("option");
      opt.value = mode === "angka" ? idx + 1 : bulan;
      opt.textContent = bulan;
      select.appendChild(opt);
    });
  }

  // Inisialisasi dropdown saat halaman load
  isiDropdownBulan("mrs-filter-month", "angka");
  isiDropdownBulan("mrs-view-bulan", "text");

  // Set default bulan/tahun ke sekarang
  const now = new Date();
  document.getElementById("mrs-filter-month").value = now.getMonth() + 1;
  document.getElementById("mrs-filter-year").value = now.getFullYear();
  document.getElementById("mrs-view-bulan").value = bulanList[now.getMonth()];
  document.getElementById("mrs-view-tahun").value = now.getFullYear();



function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'MEMPROSES...';
  document.getElementById('loadingIndicator').style.display = '';
}
function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

(function initMRSPage() {
  isiDropdownBulan("mrs-filter-month", "angka");
  isiDropdownBulan("mrs-view-bulan", "text");

  const now = new Date();
  document.getElementById("mrs-filter-month").value = now.getMonth() + 1;
  document.getElementById("mrs-filter-year").value = now.getFullYear();
  document.getElementById("mrs-view-bulan").value = bulanList[now.getMonth()];
  document.getElementById("mrs-view-tahun").value = now.getFullYear();
})();


function loadRekapSales(fromChart = false) {
  showLoading('Memproses data rekap sales...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();

  fetch(`${URL}?action=get_all_booking`)
    .then(res => res.json())
    .then(data => {
      // Filter hanya booking via TAB
      let filtered = data.filter(row => (row.via || '').toLowerCase() === 'tab');

      // Filter bulan/tahun jika dipilih
      if (selectedMonth) {
        filtered = filtered.filter(row => {
          const bookingDate = new Date(row.tanggal_penerimaan || row.tanggal_booking || '');
          const bookingMonth = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
          const bookingYear = bookingDate.getFullYear().toString();
          return bookingMonth === selectedMonth && bookingYear === selectedYear;
        });
      }

      if (filtered.length === 0) {
        document.getElementById("rekapSalesTableContainer").innerHTML = "<p>Tidak ada data booking</p>";
        hideLoading();
        return;
      }

      // Mode chart → langsung panggil updateSalesCharts()
      if (fromChart) {
        updateSalesCharts(filtered);
        hideLoading();
        return;
      }

      // ============================
      // MODE TABEL
      // ============================
      const salesStats = {};
      let totalShow = 0, totalNoShow = 0, totalResc = 0, totalAll = 0;

      filtered.forEach(row => {
        const salesName = (row.nama_sales || row.sales || '').toString().trim();
        if (!salesStats[salesName]) {
          salesStats[salesName] = { total: 0, show: 0, noshow: 0, reschedule: 0 };
        }
        salesStats[salesName].total++;
        totalAll++;

        const status = (row.status_kehadiran || row.keterangan || '').toLowerCase();
        if (status === 'show') {
          salesStats[salesName].show++;
          totalShow++;
        } else if (status === 'no show' || status === 'noshow') {
          salesStats[salesName].noshow++;
          totalNoShow++;
        } else if (status === 'reschedule' || status === 'resc') {
          salesStats[salesName].reschedule++;
          totalResc++;
        }
      });

      const sortedSales = Object.entries(salesStats)
        .sort((a, b) => b[1].total - a[1].total);

      let summaryHtml = `
        <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
          <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; min-width: 120px;">
            <strong>Show Bengkel :</strong> ${totalShow}
          </div>
          <div style="background: #ffe8e8; padding: 15px; border-radius: 8px; min-width: 120px;">
            <strong>No Show Bengkel:</strong> ${totalNoShow}
          </div>
          <div style="background: #fff3e8; padding: 15px; border-radius: 8px; min-width: 120px;">
            <strong>Reschedule:</strong> ${totalResc}
          </div>
          <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; min-width: 120px;">
            <strong>Total Booking Bengkel:</strong> ${totalAll}
          </div>
        </div>
      `;

      let tableHtml = `
        <table border="1" style="border-collapse: collapse; width: 100%;">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Sales</th>
              <th>Total Booking Bengkel</th>
              <th>Show Bengkel</th>
              <th>No Show Bengkel</th>
              <th>Reschedule</th>
            </tr>
          </thead>
          <tbody>
      `;
      let idx = 1;
      sortedSales.forEach(([sales, stats]) => {
        tableHtml += `
          <tr>
            <td>${idx++}</td>
            <td>${sales}</td>
            <td>${stats.total}</td>
            <td>${stats.show}</td>
            <td>${stats.noshow}</td>
            <td>${stats.reschedule}</td>
          </tr>
        `;
      });
      tableHtml += "</tbody></table>";

      document.getElementById("rekapSalesTableContainer").innerHTML = summaryHtml + tableHtml;
      hideLoading();
    })
    .catch(err => {
      document.getElementById('rekapSalesTableContainer').innerHTML = `<p style='color:red'>Gagal memuat data: ${err}</p>`;
      hideLoading();
    });
}

// Perbaiki tombol LIHAT GRAFIK agar kirim flag fromChart = true
function showSalesCharts() {
  document.getElementById('rekapSalesTableContainer').innerHTML = '';
  document.getElementById('salesChartsContainer').classList.remove('hidden');
  loadRekapSales(true);
}


function renderRekapSalesTable(rows) {
  const salesCount = {};
  SALES_LIST.forEach(s => salesCount[s] = 0);

  rows.forEach(row => {
    let salesVal = (row.nama_sales || row.sales || '').toString().trim().toLowerCase();
    if (SALES_LIST.includes(salesVal)) {
      salesCount[salesVal]++;
    }
  });

  // Urutkan sales berdasarkan jumlah booking (terbanyak di atas), lalu urut SALES_LIST jika sama
  const sortedSales = SALES_LIST
    .filter(s => s !== 'other')
    .sort((a, b) => {
      if (salesCount[b] !== salesCount[a]) return salesCount[b] - salesCount[a];
      return SALES_LIST.indexOf(a) - SALES_LIST.indexOf(b);
    });

  let html = `<table class="table table-bordered table-striped table-sm"><thead><tr>
    <th>No</th>
    <th>Nama Sales</th>
    <th>Jumlah Booking</th>
  </tr></thead><tbody>`;

  let idx = 1;
  sortedSales.forEach(sales => {
    html += `<tr>
      <td>${idx++}</td>
      <td>${sales.toUpperCase()}</td>
      <td>${salesCount[sales]}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('rekapSalesTableContainer').innerHTML = html;
}

function toggleOtherSalesInput(select, idx) {
  const val = select.value;
  const input = document.getElementById('other-sales-' + idx);
  if (val === 'other') {
    input.style.display = 'block';
  } else {
    input.style.display = 'none';
    input.value = '';
  }
}

function showCustomerInfo() {
  showLoading('Memproses data info customer...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  const selectedSales = document.getElementById('customer-info-sales').value;
  fetch(`${URL}?action=get_all_booking`)
    .then(res => res.json())
    .then(data => {
      // Filter hanya yang via = TAB, bulan/tahun, dan sales sesuai dropdown
      let filtered = data.filter(row => (row.via || '').toLowerCase() === 'tab');
      if (selectedMonth) {
        filtered = filtered.filter(row => {
          const bookingDate = new Date(row.tanggal_penerimaan || row.tanggal_booking || '');
          const bookingMonth = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
          const bookingYear = bookingDate.getFullYear().toString();
          return bookingMonth === selectedMonth && bookingYear === selectedYear;
        });
      }
      filtered = filtered.filter(row => ((row.nama_sales || row.sales || '').toString().trim().toLowerCase() === selectedSales));
      
      let html = `<table class="table table-bordered table-striped table-sm"><thead><tr>
        <th>No</th>
        <th>Nomor Polisi</th>
        <th>Nama Customer</th>
        <th>Tanggal Penerimaan</th>
      </tr></thead><tbody>`;
      filtered.forEach((row, idx) => {
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || row.plat || ''}</td>
          <td>${row.nama_customer || row.nama || ''}</td>
          <td>${formatTanggalOnly(row.tanggal_penerimaan || '')}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      html += `<div style='margin-top:10px;'><strong>Total Data: ${filtered.length}</strong></div>`;
      document.getElementById('customerInfoTableContainer').innerHTML = html;
      hideLoading();
    })
    .catch(err => {
      document.getElementById('customerInfoTableContainer').innerHTML = `<p style='color:red'>Gagal memuat data: ${err}</p>`;
      hideLoading();
    });
}

function showTHSBookingForm() {
  showPage("thsBookingPage");
  document.getElementById("thsBookingForm").reset();
}

document.getElementById("thsBookingForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const params = new URLSearchParams();
  formData.forEach((v, k) => params.append(k, v));
  params.append("action", "add_ths_booking");

  fetch(URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params.toString()
  })
  .then(res => res.text())
  .then(msg => {
    alert(msg);
    e.target.reset();
    showPage('rekapSalesPage');
  })
  .catch(err => {
    alert("Gagal menyimpan data THS: " + err);
  });
});


function loadRekapTHS() {
  const bulan = document.getElementById("rekap-sales-month").value.padStart(2, "0");
  const tahun = document.getElementById("rekap-sales-year").value;

  if (!bulan || !tahun) {
    alert("⚠️ Pilih bulan dan tahun terlebih dahulu.");
    return;
  }

  showLoading('Memuat Rekap THS...');

  fetch(`${URL}?action=get_ths_sales_merge&bulan=${bulan}&tahun=${tahun}`)
    .then(res => res.json()) // Backend return array JSON langsung
    .then(thsData => {
      if (!Array.isArray(thsData) || thsData.length === 0) {
        document.getElementById("rekapSalesTableContainer").innerHTML = "<p>Tidak ada data THS</p>";
        hideLoading();
        return;
      }

      const salesStats = {};
      let totalShow = 0, totalNoShow = 0, totalResc = 0, totalAll = 0;

      thsData.forEach(row => {
        const salesName = (row.nama_sales || row.sales || '').trim() || 'Tanpa Nama';
        if (!salesStats[salesName]) {
          salesStats[salesName] = { total: 0, show: 0, noshow: 0, reschedule: 0 };
        }
        salesStats[salesName].total++;
        totalAll++;

        const ket = ((row.status_kehadiran || row.keterangan) || '').toLowerCase();
        if (ket === 'show') {
          salesStats[salesName].show++;
          totalShow++;
        } else if (ket === 'noshow' || ket === 'no show') {
          salesStats[salesName].noshow++;
          totalNoShow++;
        } else if (ket === 'resc' || ket === 'reschedule') {
          salesStats[salesName].reschedule++;
          totalResc++;
        }
      });

      let summaryHtml = `
        <div style="display:flex;gap:20px;margin:20px 0;flex-wrap:wrap;">
          <div style="background:#e8f5e8;padding:15px;border-radius:8px;"><strong>Show:</strong> ${totalShow}</div>
          <div style="background:#ffe8e8;padding:15px;border-radius:8px;"><strong>No Show:</strong> ${totalNoShow}</div>
          <div style="background:#fff3e8;padding:15px;border-radius:8px;"><strong>Reschedule:</strong> ${totalResc}</div>
          <div style="background:#f0f0f0;padding:15px;border-radius:8px;"><strong>Total:</strong> ${totalAll}</div>
        </div>
      `;

      let tableHtml = `
        <table border="1" style="border-collapse:collapse;width:100%;">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Sales</th>
              <th>Total Booking</th>
              <th>Show</th>
              <th>No Show</th>
              <th>Reschedule</th>
            </tr>
          </thead>
          <tbody>
      `;

      let idx = 1;
      Object.keys(salesStats).forEach(sales => {
        tableHtml += `
          <tr>
            <td>${idx++}</td>
            <td>${sales}</td>
            <td>${salesStats[sales].total}</td>
            <td>${salesStats[sales].show}</td>
            <td>${salesStats[sales].noshow}</td>
            <td>${salesStats[sales].reschedule}</td>
          </tr>
        `;
      });

      tableHtml += "</tbody></table>";
      document.getElementById("rekapSalesTableContainer").innerHTML = summaryHtml + tableHtml;
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat rekap THS: " + err);
      hideLoading();
    });
}


function loadTotalBookingSales() {
  const bulan = document.getElementById("rekap-sales-month").value.padStart(2, "0");
  const tahun = document.getElementById("rekap-sales-year").value;
  showLoading('Memuat Total Booking Sales...'); 

  


  fetch(`${URL}?action=get_booking_sales_merge&bulan=${bulan}&tahun=${tahun}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        throw new Error("Data bukan array, cek backend!");
      }

      const salesStats = {};
      const totals = {
        total_booking: 0,
        total_booking_bengkel: 0,
        total_booking_ths: 0,
        show_bengkel: 0,
        show_ths: 0,
        noshow_bengkel: 0,
        noshow_ths: 0,
        resc_bengkel: 0,
        resc_ths: 0
      };

      // Fungsi normalisasi nama untuk kunci penggabungan
      function normalizeName(name) {
        return name.trim().toLowerCase();
      }

      // Fungsi format nama untuk tampilan
      function formatName(name) {
        return name
          .trim()
          .toLowerCase()
          .replace(/\b\w/g, c => c.toUpperCase());
      }

      function addStats(key, displayName, type, status) {
        if (!salesStats[key]) {
          salesStats[key] = { 
            displayName: displayName,
            total_booking: 0,
            total_booking_bengkel: 0,
            total_booking_ths: 0,
            show_bengkel: 0,
            show_ths: 0,
            noshow_bengkel: 0,
            noshow_ths: 0,
            resc_bengkel: 0,
            resc_ths: 0
          };
        }

        salesStats[key].total_booking++;
        if (type === "bengkel") salesStats[key].total_booking_bengkel++;
        else if (type === "ths") salesStats[key].total_booking_ths++;

        if (status === "show") {
          if (type === "bengkel") salesStats[key].show_bengkel++;
          else if (type === "ths") salesStats[key].show_ths++;
        } 
        else if (status === "noshow" || status === "no show") {
          if (type === "bengkel") salesStats[key].noshow_bengkel++;
          else if (type === "ths") salesStats[key].noshow_ths++;
        } 
        else if (status === "reschedule" || status === "resc") {
          if (type === "bengkel") salesStats[key].resc_bengkel++;
          else if (type === "ths") salesStats[key].resc_ths++;
        }
      }

      data.forEach(row => {
        const rawName = (row.nama_sales || row.sales || "").trim() || "Tanpa Nama";
        const salesKey = normalizeName(rawName);
        const displayName = formatName(rawName);
        const type = (row.source_type || "bengkel").toLowerCase();
        const status = ((row.status_kehadiran || row.keterangan) || "").toLowerCase();
        addStats(salesKey, displayName, type, status);
      });

      // Hitung total semua kolom
      Object.values(salesStats).forEach(s => {
        for (let key in totals) totals[key] += s[key];
      });

      // Urutkan berdasarkan total booking
      const sorted = Object.entries(salesStats).sort((a, b) => b[1].total_booking - a[1].total_booking);

      let html = `<table border="1" style="border-collapse:collapse;width:100%">
        <thead>
          <p><strong>Periode:</strong> ${bulan ? getMonthName(bulan) + ' ' + tahun : 'Semua Periode'}</p>
          <tr>
            <th>No</th>
            <th>Nama Sales</th>
            <th>Total Booking</th>
            <th>Total Booking Bengkel</th>
            <th>Total Booking THS</th>
            <th>Show Bengkel</th>
            <th>Show THS</th>
            <th>No Show Bengkel</th>
            <th>No Show THS</th>
            <th>Reschedule Bengkel</th>
            <th>Reschedule THS</th>
          </tr>
        </thead>
        <tbody>`;

      let idx = 1;
      sorted.forEach(([key, s]) => {
        html += `<tr>
          <td>${idx++}</td>
          <td>${s.displayName}</td>
          <td>${s.total_booking}</td>
          <td>${s.total_booking_bengkel}</td>
          <td>${s.total_booking_ths}</td>
          <td>${s.show_bengkel}</td>
          <td>${s.show_ths}</td>
          <td>${s.noshow_bengkel}</td>
          <td>${s.noshow_ths}</td>
          <td>${s.resc_bengkel}</td>
          <td>${s.resc_ths}</td>
        </tr>`;
      });

      // TOTAL BARIS BAWAH
      html += `<tr style="font-weight:bold;background:#f0f0f0">
        <td colspan="2">TOTAL</td>
        <td>${totals.total_booking}</td>
        <td>${totals.total_booking_bengkel}</td>
        <td>${totals.total_booking_ths}</td>
        <td>${totals.show_bengkel}</td>
        <td>${totals.show_ths}</td>
        <td>${totals.noshow_bengkel}</td>
        <td>${totals.noshow_ths}</td>
        <td>${totals.resc_bengkel}</td>
        <td>${totals.resc_ths}</td>
      </tr>`;

      html += `</tbody></table>`;

      document.getElementById("rekapSalesTableContainer").innerHTML = html;
      hideLoading();
    })
    .catch(err => {
      document.getElementById("rekapSalesTableContainer").innerHTML = `<p style="color:red">Error: ${err}</p>`;
      hideLoading();
    });
}

function updateSalesCharts(data) {
  const salesStats = {};
  SALES_LIST.forEach(sales => {
    salesStats[sales] = 0;
  });
  
  data.forEach(row => {
    const salesName = (row.nama_sales || row.sales || '').toLowerCase();
    if (salesStats.hasOwnProperty(salesName)) {
      salesStats[salesName]++;
    }
  });

  const salesWithData = Object.entries(salesStats).filter(([_, count]) => count > 0);
  

  salesWithData.sort((a, b) => b[1] - a[1]);
  

  const labels = salesWithData.map(([sales, _]) => sales.toUpperCase());
  const values = salesWithData.map(([_, count]) => count);
  const colors = generateColors(salesWithData.length);
  renderBarChart(labels, values, colors);
  updateSalesSummary(salesWithData);
}

function renderBarChart(labels, values, colors) {
  const canvas = document.getElementById('salesBarChart');
  const ctx = canvas.getContext('2d');
  
  // Bersihkan kanvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  const maxValue = Math.max(...values);
  const barWidth = 30;
  const barSpacing = 20;
  const chartHeight = canvas.height - 100;
  
  // Perbaikan di sini: hitung lebar total grafik dengan benar
  const chartWidth = labels.length * (barWidth + barSpacing) - barSpacing;
  const startX = (canvas.width - chartWidth) / 2;
  
  // Gambar sumbu Y dan labelnya (opsional, tapi disarankan)
  ctx.strokeStyle = '#ccc';
  ctx.beginPath();
  ctx.moveTo(startX, 60);
  ctx.lineTo(startX, canvas.height - 80);
  ctx.stroke();

  // Gambar setiap batang
  labels.forEach((label, index) => {
    const barHeight = (values[index] / maxValue) * chartHeight;
    const x = startX + index * (barWidth + barSpacing);
    const y = canvas.height - 80 - barHeight;
    
    // Gambar batang
    ctx.fillStyle = colors[index];
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // Tampilkan nilai di atas batang
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(values[index], x + barWidth / 2, y - 5);
    
    // Tampilkan label di bawah batang
    ctx.fillText(label, x + barWidth / 2, canvas.height - 20);
  });
}

function updateSalesSummary(salesWithData) {
  if (salesWithData.length === 0) {
    document.getElementById('salesSummaryContent').innerHTML = '<p>Tidak ada data booking untuk periode yang dipilih.</p>';
    return;
  }
  
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  
  const topSales = salesWithData[0];
  const totalBookings = salesWithData.reduce((sum, [_, count]) => sum + count, 0);
  
  let html = `
    <p><strong>Periode:</strong> ${selectedMonth ? getMonthName(selectedMonth) + ' ' + selectedYear : 'Semua Periode'}</p>
    <p><strong>Total Booking:</strong> ${totalBookings}</p>
    <p><strong>Sales Terbanyak:</strong> ${topSales[0].toUpperCase()} dengan ${topSales[1]} booking</p>
    <p><strong>Persentase Sales Terbanyak:</strong> ${((topSales[1] / totalBookings) * 100).toFixed(1)}%</p>
  `;
  
  document.getElementById('salesSummaryContent').innerHTML = html;
}

function generateColors(count) {
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384',
    '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
  ];
  
  return colors.slice(0, count);
}

function updateSalesRekapSpreadsheet() {
  showLoading('Mengupdate data Sales Rekap...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  if (!selectedMonth || !selectedYear) {
    alert('Pilih bulan dan tahun terlebih dahulu!');
    hideLoading();
    return;
  }
  if (!confirm('Yakin ingin mengupdate spreadsheet Sales Rekap untuk bulan ini?')) {
    hideLoading();
    return;
  }
  const params = new URLSearchParams();
  params.append("action", "update_sales_rekap");
  params.append("bulan", selectedMonth);
  params.append("tahun", selectedYear);
  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      hideLoading();
    })
    .catch(err => {
      alert("Gagal mengupdate spreadsheet: " + err);
      hideLoading();
    });
}

function showPage(id) {
  [
    "loginPage", "dashboardPage", "bookingPage", "dataPage", "rekapPage",
    "mrsPage", "mrsInputPage", "mrsViewPage", "mrsViewByMonthPage",
    "rekapSalesPage", "infoCustomerPage", "thsBookingPage", "thsEditPage"
  ].forEach(p => {
    const el = document.getElementById(p);
    if (el) el.classList.add("hidden"); // pastikan elementnya ada
  });

  document.getElementById(id).classList.remove("hidden");

  if (id === 'rekapSalesPage') {
    loadRekapSales();
    populateCustomerInfoSalesDropdown(); 
  }
  if (id === 'infoCustomerPage') {
    populateCustomerInfoSalesDropdown(); 
  }
  hideLoading();
}
function checkLogin() {
  if (localStorage.getItem("isLoggedIn") === "true") {
    showPage("dashboardPage");
  } else {
    showPage("loginPage");
  }
}

function logout() {
  localStorage.removeItem("isLoggedIn");
  checkLogin();
}

document.getElementById("loginForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const username = e.target.username.value.trim();
  const password = e.target.password.value.trim();
  if (username === "agmeylanecha@gmail.com" && password === "saturjeff") {
    localStorage.setItem("isLoggedIn", "true");
    showPage("dashboardPage");
    e.target.reset();
  } else {
    alert("Email atau password salah!");
  }
});

document.getElementById("bookingForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  

  const tipeTelepon = form.tipe_telepon.value;
  if (tipeTelepon === "SA") {
    formData.set("nohp", form.nohp_sa.value);
    formData.set("datang", form.datang_dropdown.value);
  } else {
    const noHpInput = document.getElementById("nohp_input").value;
    if (noHpInput) {
      const cleanNumber = noHpInput.replace(/^62/, '');
      formData.set("nohp", "62" + cleanNumber);
    } else {
      formData.set("nohp", "");
    }
    formData.set("datang", form.datang.value);
  }
  
 
  let salesValue = form.sales.value;
  if (salesValue === 'other') {
    salesValue = form.sales_other.value;
  }
  formData.set('sales', salesValue);

  formData.forEach((v, k) => params.append(k, v));

  const isEdit = form.editId.value !== "";
  if (isEdit) {
    params.append("id_row", form.editId.value);
    params.append("sheetName", form.sheetName.value);
    params.append("action", "edit");
    params.append("status_kehadiran", document.getElementById("status_kehadiran_select").value);
  }

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      
      if (isEdit) {
        // Clear edit mode
        document.getElementById("editId").value = "";
        document.getElementById("sheetName").value = "";
        document.getElementById("statusGroup").classList.add("hidden");
        document.getElementById("submitBtn").textContent = "Kirim";
        
        // Reset form and return to data page
        form.reset();
        showPage("dataPage");
        
        // Reload data to show updated information
        loadData();
      } else {
        // Reset form for new booking
        form.reset();
        document.getElementById("phoneInputGroup").style.display = "none";
        document.getElementById("saPhoneGroup").style.display = "none";
        document.getElementById("customerDatangGroup").style.display = "block";
        document.getElementById("customerDatangDropdown").style.display = "none";
      }
    })
    .catch(err => {
      alert("Gagal menyimpan data: " + err);
    });
});

function loadData() {
  showLoading('Memproses data booking...');
  const tanggal = document.getElementById("filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  fetch(`${URL}?tanggal_penerimaan=${tanggal}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='15'>Tidak ada data</td></tr>";
        document.getElementById("dataTable").classList.remove("hidden");
        hideLoading();
        return;
      }

      data.forEach((row, idx) => {
        
        const status = row.status_kehadiran || "";
        // Pastikan status ditampilkan dengan benar - jangan tampilkan "-" jika ada status
        const displayStatus = status ? status : "-"; 
        
        // Debug: Log status for each row
        console.log(`Row ${idx + 1} - ID: ${row.id_row}, Status: "${status}", Display: "${displayStatus}"`);
        
        const tds = `
          <td>${idx + 1}</td>
          <td><span class="status-${status.toLowerCase().replace(/\s+/g, '-')}">${displayStatus}</span></td>
          <td>${row.nomor_polisi || row.plat || ""}</td>
          <td>${row.tipe_kendaraan || row.tipe || ""}</td>
          <td>${row.tahun || ""}</td>
          <td>${row.no_hp || row.nohp || ""}</td>
          <td>${row.customer_akan_datang || row.datang || ""}</td>
          <td>${row.nama_customer || row.nama || ""}</td>
          <td>${formatDateOnly(row.tanggal_booking)}</td>
          <td>${formatDateOnly(row.tanggal_penerimaan)}</td>
          <td>${formatJam(row.jam_penerimaan || "")}</td>
          <td>${row.via || ""}</td>
          <td>${row.admin || ""}</td>
          <td>${row.jenis_pekerjaan || row.keluhan || ""}</td>
          <td>${row.nama_sales || row.sales || ""}</td>
          <td>
            <button onclick='editRow(${JSON.stringify(row)})'>Edit</button>
            <button onclick='deleteRow("${row.id_row}", "${row.tanggal_penerimaan}", "${row.sheetName}", this)'>Hapus</button>
            <button onclick='showKedatanganModal(${JSON.stringify(row)})' style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; margin-top: 2px;">Kedatangan</button>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });

      document.getElementById("dataTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data: " + err);
      hideLoading();
    });
}


function showNewBookingForm() {
  showPage("bookingPage");
  const form = document.getElementById("bookingForm");
  form.reset();
  document.getElementById("editId").value = "";
  document.getElementById("sheetName").value = "";
  document.getElementById("submitBtn").textContent = "Kirim";
  document.getElementById("statusGroup").classList.add("hidden");
  document.getElementById("tipe_telepon").value = "";
  document.getElementById("phoneInputGroup").style.display = "none";
  document.getElementById("saPhoneGroup").style.display = "none";
  document.getElementById("customerDatangGroup").style.display = "block";
  document.getElementById("customerDatangDropdown").style.display = "none";
  document.getElementById("datang_input").value = "";
  document.getElementById("datang_select").value = "";
}

function togglePhoneInput() {
  const tipeTelepon = document.getElementById("tipe_telepon").value;
  if (tipeTelepon === "SA") {
    document.getElementById("phoneInputGroup").style.display = "none";
    document.getElementById("saPhoneGroup").style.display = "block";
    document.getElementById("customerDatangGroup").style.display = "none";
    document.getElementById("customerDatangDropdown").style.display = "block";
  } else {
    document.getElementById("phoneInputGroup").style.display = "block";
    document.getElementById("saPhoneGroup").style.display = "none";
    document.getElementById("customerDatangGroup").style.display = "block";
    document.getElementById("customerDatangDropdown").style.display = "none";
  }
}


function formatPhoneNumber(input) {
  let value = input.value.replace(/\D/g, ''); 
  
  
  if (value.startsWith('62')) {
    value = value.substring(2);
  }
  
  
  if (value.length > 12) {
    value = value.substring(0, 12);
  }
  
  input.value = value;
}


document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.getElementById('nohp_input');
  if (phoneInput) {
    phoneInput.addEventListener('input', function() {
      formatPhoneNumber(this);
    });
    
    
    phoneInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      let cleanText = pastedText.replace(/\D/g, '');
      if (cleanText.startsWith('62')) {
        cleanText = cleanText.substring(2);
      }
      if (cleanText.length > 12) {
        cleanText = cleanText.substring(0, 12);
      }
      this.value = cleanText;
    });
  }
  
  
  const currentMonth = new Date().toLocaleString('id-ID', { month: 'long' });
  const reminderMonthSelect = document.querySelector('select[name="reminder_month"]');
  if (reminderMonthSelect) {
    reminderMonthSelect.value = currentMonth;
  }
});


document.getElementById("mrsForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  
  let nohp = form.nohp_mrs.value.replace(/\D/g, '');
  if (nohp.startsWith('62')) nohp = nohp.substring(2);
  params.append("nohp_mrs", "62" + nohp);
  formData.forEach((v, k) => {
    if (k !== "nohp_mrs") params.append(k, v);
  });
  params.append("action", "add_mrs");

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      form.reset();
      document.getElementById("reminder_month_select").value = new Date().toLocaleString('id-ID', { month: 'long' });
    })
    .catch(err => {
      alert("Gagal menyimpan data MRS: " + err);
    });
});



// ======================
// Fungsi Load MRS Data
// ======================
function loadMRSData() {
  showLoading('Memproses data MRS...');

  const now = new Date();
  const selectedMonth = parseInt(document.getElementById("mrs-filter-month").value, 10) || (now.getMonth() + 1);
  const selectedYear = parseInt(document.getElementById("mrs-filter-year").value, 10) || now.getFullYear();

  fetch(`${URL}?action=get_mrs_view&bulan=${selectedMonth}&tahun=${selectedYear}`)
    .then(res => res.json())
    .then(data => renderMRSTable(data, "#mrsTable", true))
    .catch(err => {
      alert("Gagal memuat data MRS: " + err);
      hideLoading();
    });
}

function renderMRSTable(data, tableSelector, allowUpdate) {
  const current = Array.isArray(data.current) ? data.current : [];
  const previous = Array.isArray(data.previous) ? data.previous : [];
  const tbody = document.querySelector(`${tableSelector} tbody`);
  tbody.innerHTML = "";

  if (current.length === 0) {
    tbody.innerHTML = `<tr><td colspan='${allowUpdate ? 8 : 7}'>Tidak ada data MRS</td></tr>`;
    document.querySelector(tableSelector).classList.remove("hidden");
    hideLoading();
    return;
  }

  // Simpan histori status sebelumnya berdasarkan nomor polisi
  const historyMap = {};
  previous.forEach(row => {
    const plat = (row.nomor_polisi || "").toString().trim().toUpperCase();
    if (row.status) {
      historyMap[plat] = {
        status: row.status,
        catatan: row.catatan || "",
        tanggal_update: row.tanggal_update || ""
      };
    }
  });

  current.forEach((row, idx) => {
    const platKey = (row.nomor_polisi || "").toString().trim().toUpperCase();

    let statusText = row.status || "";
    let catatanText = row.catatan || "";
    let tanggalText = row.tanggal_update || "";
    let fromHistory = false;

    if (!statusText && historyMap[platKey]) {
      const hist = historyMap[platKey];
      statusText = hist.status;
      catatanText = hist.catatan;
      tanggalText = hist.tanggal_update;
      fromHistory = true;
    }

    let statusClass = "status-default";
    if (typeof statusText === "string" && statusText.toLowerCase().includes("sudah")) {
      statusClass = "status-show";
    } else if (typeof statusText === "string" && statusText.toLowerCase().includes("belum")) {
      statusClass = "status-no-show";
    }

    const statusDisplay = `<span class="${statusClass}">${statusText || 'Belum Dihubungi'}</span>` +
      (tanggalText ? ` (${tanggalText})` : "") +
      (fromHistory ? ` <small style="color:gray">(Histori)</small>` : "");
    const catatanDisplay = catatanText ? `<br><small>Catatan: ${catatanText}</small>` : '';

    // Tombol aksi
    let actionButtons = `
      <a href="https://wa.me/${row.no_hp || ''}?text=${encodeURIComponent(`Yth. Bapak/Ibu ${row.nama_customer || ''} ...`)}" target="_blank" title="Kirim via WhatsApp App">
        <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' style='width:24px;height:24px;vertical-align:middle;'>
      </a>
      <a href="https://web.whatsapp.com/send?phone=${row.no_hp || ''}&text=${encodeURIComponent(`Yth. Bapak/Ibu ${row.nama_customer || ''} ...`)}" target="_blank" title="Kirim via WhatsApp Web">
        <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' style='width:24px;height:24px;vertical-align:middle;filter: grayscale(100%) brightness(0.7);'>
      </a>
    `;

    if (allowUpdate) {
      actionButtons = `
        <button onclick='showMRSStatusModal(${JSON.stringify(row)}, ${JSON.stringify(historyMap[platKey] || null)})' style="background:#28a745;color:white;border:none;padding:4px 8px;border-radius:3px;">
          Update Status
        </button>
       <button onclick='deleteMRS("${row.nomor_polisi}", "${row.bulan}", "${row.tahun}", this)'>Hapus</button>
        ${actionButtons}
      `;
    }

    // Buat baris tabel
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${row.nomor_polisi || ""}</td>
      <td>${row.bulan || ""}</td>
      <td>${row.ch || ""}</td>
      <td>${row.nama_customer || ""}</td>
      <td>${row.no_hp || ""}</td>
      ${allowUpdate ? `<td>${statusDisplay}${catatanDisplay}</td>` : ""}
      <td>${actionButtons}</td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelector(tableSelector).classList.remove("hidden");
  hideLoading();
}



// ======================
// Modal & Update Status
// ======================
function showMRSStatusModal(row) {
  document.getElementById('mrs-modal-plat').textContent = row.nomor_polisi || '';
  document.getElementById('mrs-modal-nama').textContent = row.nama_customer || '';
  document.getElementById('mrs-modal-status').value = row.status || '';
  document.getElementById('mrs-modal-catatan').value = row.catatan || '';

  const modal = document.getElementById('mrsStatusModal');
  modal.dataset.nopol = row.nomor_polisi || ''; // simpan nopol
  modal.dataset.bulan = row.bulan;   
  modal.dataset.tahun = row.tahun;   
  modal.classList.remove('hidden');
}

function closeMRSStatusModal() {
  document.getElementById('mrsStatusModal').classList.add('hidden');
}

function updateMRSStatus() {
  const nopol = document.getElementById('mrsStatusModal').dataset.nopol;
  const bulan = document.getElementById('mrsStatusModal').dataset.bulan;
  const tahun = document.getElementById('mrsStatusModal').dataset.tahun;
  
  const status = document.getElementById('mrs-modal-status').value;
  const catatan = document.getElementById('mrs-modal-catatan').value;
  const admin = localStorage.getItem("username") || "Admin";

  if (!status) {
    alert("Pilih status dulu");
    return;
  }

  const params = new URLSearchParams();
  params.append("action", "update_mrs_status");
  params.append("nomor_polisi", nopol); // kirim nopol
  params.append("bulan", bulan);
  params.append("tahun", tahun);
  params.append("status", status);
  params.append("catatan", catatan);
  params.append("admin", admin);

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      closeMRSStatusModal();
      loadMRSData();
    })
    .catch(err => {
      alert("Gagal update status: " + err);
    });
}





// ======================
// View MRS per Bulan
// ======================
function loadMRSView() {
  showLoading('Memproses data MRS View...');
  const bulan = document.getElementById("mrs-view-bulan").value;
  const tahun = document.getElementById("mrs-view-tahun").value;
  fetch(`${URL}?action=get_mrs_view&bulan=${bulan}&tahun=${tahun}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#mrsViewTable tbody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>Tidak ada data MRS</td></tr>";
        document.getElementById("mrsViewTable").classList.remove("hidden");
        hideLoading();
        return;
      }
      data.forEach((row, idx) => {
        const ch = row.ch || "";
        const namaCustomer = row.nama_customer || "";
        const waNumber = row.no_hp || "";
        const pesan =
`Yth. Bapak/Ibu ${namaCustomer}\nKami mengingatkan untuk kendaraan ${row.nomor_polisi || ""} sudah waktunya service berkala (${ch} KM) atau 6 bulan setelah service kendaraan\n\nApakah Bapak/Ibu bersedia kami booking kan di Bulan ${row.bulan || ""} ${tahun}?\n\nBOOKING Maksimal H-2 / H-1 sebelum service\n\nAbaikan pesan ini jika sudah melakukan service\n\nKami pun memiliki layanan THS - Auto2000 Home Service yang dapat melakukan service di tempat anda (rumah/kantor, dsb). \n\nCintai Keluarga dan Kendaraan Anda!\n\nHotline : 022-602.2000 / 6010010\n\nSenin - Jum'at : 08.00 s/d 16.00\nSabtu : 08.00 s/d 13:00\nHari Minggu dan hari besar operasional booking service Libur.\n\nJl. Soekarno Hatta No. 145 Bandung ( Caringin )`;
        const waLinkApp = `https://wa.me/${waNumber}?text=${encodeURIComponent(pesan)}`;
        const waLinkWeb = `https://web.whatsapp.com/send?phone=${waNumber}&text=${encodeURIComponent(pesan)}`;
        const tds = `
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || ""}</td>
          <td>${row.bulan || ""}</td>
          <td>${ch}</td>
          <td>${namaCustomer}</td>
          <td>${waNumber}</td>
          <td>
            <button onclick="deleteMRS(${idx})" title="Hapus" style="background:#b30000;color:white;border:none;padding:6px 12px;border-radius:5px;">Hapus</button>
            <a href="${waLinkApp}" target="_blank" title="Kirim via WhatsApp App">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA App' style='width:24px;height:24px;vertical-align:middle;'>
            </a>
            <a href="${waLinkWeb}" target="_blank" title="Kirim via WhatsApp Web">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA Web' style='width:24px;height:24px;vertical-align:middle;filter: grayscale(100%) brightness(0.7);'>
            </a>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });
      document.getElementById("mrsViewTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data MRS: " + err);
      hideLoading();
    });
}

function sendWhatsApp(waNumber, pesan) {
  if (confirm("Pastikan nomor sudah terdaftar di WhatsApp. Lanjutkan kirim pesan?")) {
    const waLink = `https://wa.me/${waNumber}?text=${pesan}`;
    window.open(waLink, '_blank');
  }
}

// ======================
// Hapus MRS
// ======================
function deleteMRS(nomor_polisi, bulan, tahun, btn) {
  if (!confirm("Yakin ingin menghapus data MRS ini?")) return;

  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }

  const params = new URLSearchParams();
  params.append("action", "delete_mrs");
  params.append("nomor_polisi", nomor_polisi);
  params.append("bulan", bulan);
  params.append("tahun", tahun);

  fetch(URL, { method: "POST", body: params })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadMRSData();
    })
    .catch(err => {
      alert("Gagal menghapus data MRS: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}





function editRow(row) {
    showPage("bookingPage");
    const form = document.getElementById("bookingForm");
    form.reset();
    
    // Set ID dan nama sheet untuk proses update
    form.editId.value = row.id_row;
    form.sheetName.value = row.sheetName || "";

    // Tampilkan group status kehadiran dan isi nilainya
    document.getElementById("statusGroup").classList.remove("hidden");
    document.getElementById("status_kehadiran_select").value = row.status_kehadiran || "";
    
    // Isi semua input form dengan data dari baris yang dipilih
    form.plat.value = row.nomor_polisi || row.plat || "";
    form.tipe.value = row.tipe_kendaraan || row.tipe || "";
    form.tahun.value = row.tahun || "";

    // Logika untuk mengisi Tipe Telepon dan Nomor HP
    const tipeTelepon = row.tipe_telepon || "";
    document.getElementById("tipe_telepon").value = tipeTelepon;
    togglePhoneInput(); 

    if (tipeTelepon === "SA") {
        document.getElementById("nohp_sa_select").value = row.no_hp || "";
        document.getElementById("nohp_input").value = "";
    } else {
        document.getElementById("nohp_input").value = row.no_hp || "";
        document.getElementById("nohp_sa_select").value = "";
    }

    // Logika untuk mengisi Customer Akan Datang
    const datang = row.customer_akan_datang || row.datang || "";
    if (tipeTelepon === "SA") {
        document.getElementById("datang_select").value = datang;
        document.getElementById("datang_input").value = "";
    } else {
        document.getElementById("datang_input").value = datang;
        document.getElementById("datang_select").value = "";
    }
    toggleCustomerDatangInput();

    form.nama.value = row.nama_customer || row.nama || "";
    form.tanggal_penerimaan.value = formatTanggalOnly(row.tanggal_penerimaan || "");
    form.jam_penerimaan.value = row.jam_penerimaan || "";
    form.via.value = row.via || "";
    form.admin.value = row.admin || "";
    form.keluhan.value = row.jenis_pekerjaan || row.keluhan || "";

    // Logika untuk mengisi Nama Sales
    const salesVal = (row.nama_sales || row.sales || "").toLowerCase();
    const salesSelect = document.getElementById("sales_select");
    const otherInput = document.getElementById("sales_other_input");

    if (SALES_LIST.includes(salesVal)) {
        salesSelect.value = salesVal;
        otherInput.style.display = "none";
        otherInput.value = "";
    } else if (salesVal) {
        salesSelect.value = "other";
        otherInput.style.display = "block";
        otherInput.value = salesVal;
    } else {
        salesSelect.value = "";
        otherInput.style.display = "none";
        otherInput.value = "";
    }
    
    // Ubah teks tombol menjadi "Update"
    form.querySelector("#submitBtn").textContent = "Update";
}


function deleteRow(id_row, tanggal, sheetName, btn) {
  if (!confirm("Yakin ingin hapus data ini?")) return;
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }
  const params = new URLSearchParams();
  params.append("id_row", id_row);
  params.append("tanggal_penerimaan", tanggal);
  params.append("sheetName", sheetName);
  params.append("action", "delete");

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadData();
    })
    .catch(err => {
      alert("Gagal menghapus data: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}

function loadRekap() {
  showLoading('Memproses data rekap...');
  const tanggal = document.getElementById("rekap-filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  fetch(`${URL}?tanggal_penerimaan=${tanggal}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#rekapTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='9'>Tidak ada data</td></tr>";
        document.getElementById("rekapTable").classList.remove("hidden");
        document.getElementById("rekapSummary").classList.add("hidden");
        document.getElementById("exportBtn").classList.add("hidden");
        hideLoading();
        return;
      }

      
      let showCount = 0, noShowCount = 0, rescheduleCount = 0, unknownCount = 0;
      
      data.forEach((row, idx) => {
        const status = row.status_kehadiran || "";
        if (status === "show") showCount++;
        else if (status === "no show") noShowCount++;
        else if (status === "reschedule") rescheduleCount++;
        else unknownCount++; 

        const displayStatus = status || "-"; 

        const tds = `
          <td>${idx + 1}</td>
          <td>${displayStatus}</td>
          <td>${row.nomor_polisi || row.plat || ""}</td>
          <td>${row.nama_customer || row.nama || ""}</td>
          <td>${formatDateOnly(row.tanggal_penerimaan)}</td>
          <td>${formatJam(row.jam_penerimaan || "")}</td>
          <td>${row.via || ""}</td>
          <td>${row.admin || ""}</td>
          <td>${row.nama_sales || row.sales || ""}</td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });

      
      document.getElementById("showCount").textContent = showCount;
      document.getElementById("noShowCount").textContent = noShowCount;
      document.getElementById("rescheduleCount").textContent = rescheduleCount;
      document.getElementById("totalCount").textContent = data.length;

      document.getElementById("rekapTable").classList.remove("hidden");
      document.getElementById("rekapSummary").classList.remove("hidden");
      document.getElementById("exportBtn").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data rekap: " + err);
      hideLoading();
    });
}

function exportRekapToSpreadsheet() {
  showLoading('Mengekspor data rekap...');
  const tanggal = document.getElementById("rekap-filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  const params = new URLSearchParams();
  params.append("action", "export_rekap");
  params.append("tanggal_penerimaan", tanggal);

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
    })
    .catch(err => {
      alert("Gagal export ke spreadsheet: " + err);
    });
  hideLoading();
}

function loadMRSView() {
  showLoading('Memproses data MRS View...');
  const bulan = document.getElementById("mrs-view-bulan").value;
  const tahun = document.getElementById("mrs-view-tahun").value;
  fetch(`${URL}?action=get_mrs_view&bulan=${bulan}&tahun=${tahun}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#mrsViewTable tbody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>Tidak ada data MRS</td></tr>";
        document.getElementById("mrsViewTable").classList.remove("hidden");
        hideLoading();
        return;
      }
      data.forEach((row, idx) => {
        const ch = row.ch || "";
        const namaCustomer = row.nama_customer || "";
        const waNumber = row.no_hp || "";
        const pesan =
`Yth. Bapak/Ibu ${namaCustomer}\nKami mengingatkan untuk kendaraan ${row.nomor_polisi || ""} sudah waktunya service berkala (${ch}) atau 6 bulan setelah service kendaraan\n\nApakah Bapak/Ibu bersedia kami booking kan di Bulan ${row.bulan || ""} ${tahun}?\n\nBOOKING Maksimal H-2 / H-1 sebelum service\n\nAbaikan pesan ini jika sudah melakukan service\n\nKami pun memiliki layanan THS - Auto2000 Home Service yang dapat melakukan service di tempat anda (rumah/kantor, dsb). \n\nCintai Keluarga dan Kendaraan Anda!\n\nHotline : 022-602.2000 / 6010010\n\nSenin - Jum'at : 08.00 s/d 16.00\nSabtu : 08.00 s/d 13:00\nHari Minggu dan hari besar operasional booking service Libur.\n\nJl. Soekarno Hatta No. 145 Bandung ( Caringin )`;
        const waLinkApp = `https://wa.me/${waNumber}?text=${encodeURIComponent(pesan)}`;
        const waLinkWeb = `https://web.whatsapp.com/send?phone=${waNumber}&text=${encodeURIComponent(pesan)}`;
        const tds = `
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || ""}</td>
          <td>${row.bulan || ""}</td>
          <td>${ch}</td>
          <td>${namaCustomer}</td>
          <td>${waNumber}</td>
          <td>
            <button onclick="deleteMRS(${idx})" title="Hapus" style="background:#b30000;color:white;border:none;padding:6px 12px;border-radius:5px;">Hapus</button>
            <a href="${waLinkApp}" target="_blank" title="Kirim via WhatsApp App">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA App' style='width:24px;height:24px;vertical-align:middle;'>
            </a>
            <a href="${waLinkWeb}" target="_blank" title="Kirim via WhatsApp Web">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA Web' style='width:24px;height:24px;vertical-align:middle;filter: grayscale(100%) brightness(0.7);'>
            </a>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });
      document.getElementById("mrsViewTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data MRS: " + err);
      hideLoading();
    });
}

function sendWhatsApp(waNumber, pesan) {
  if (confirm("Pastikan nomor sudah terdaftar di WhatsApp. Lanjutkan kirim pesan?")) {
    const waLink = `https://wa.me/${waNumber}?text=${pesan}`;
    window.open(waLink, '_blank');
  }
}

// ======================
// Hapus MRS
// ======================
function deleteMRS(nomor_polisi, bulan, tahun, btn) {
  if (!confirm("Yakin ingin menghapus data MRS ini?")) return;

  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }

  const params = new URLSearchParams();
  params.append("action", "delete_mrs");
  params.append("nomor_polisi", nomor_polisi);
  params.append("bulan", bulan);
  params.append("tahun", tahun);

  fetch(URL, { method: "POST", body: params })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadMRSData();
    })
    .catch(err => {
      alert("Gagal menghapus data MRS: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}

function toggleOtherSalesBooking() {
  const select = document.getElementById('sales_select');
  const input = document.getElementById('sales_other_input');
  if (select.value === 'other') {
    input.style.display = 'block';
  } else {
    input.style.display = 'none';
    input.value = '';
  }
}

function populateCustomerInfoSalesDropdown() {
  const select = document.getElementById('customer-info-sales');
  select.innerHTML = SALES_LIST.filter(s => s !== 'other').map(s => `<option value="${s}">${s.toUpperCase()}</option>`).join('');
}

// Kedatangan Modal Functions
let currentKedatanganRow = null;

function showKedatanganModal(row) {
  currentKedatanganRow = row;
  console.log('Opening modal for row:', row);
  document.getElementById('modal-plat').textContent = row.nomor_polisi || row.plat || '';
  document.getElementById('modal-nama').textContent = row.nama_customer || row.nama || '';
  document.getElementById('modal-status-kehadiran').value = row.status_kehadiran || 'show';
  document.getElementById('modal-catatan').value = '';
  document.getElementById('kedatanganModal').classList.remove('hidden');
}

function closeKedatanganModal() {
  document.getElementById('kedatanganModal').classList.add('hidden');
  currentKedatanganRow = null;
}

function updateKedatanganStatus() {
  if (!currentKedatanganRow) {
    alert('Data tidak ditemukan!');
    return;
  }

  const statusKehadiran = document.getElementById('modal-status-kehadiran').value;
  const catatan = document.getElementById('modal-catatan').value;

  if (!statusKehadiran) {
    alert('Pilih status kehadiran!');
    return;
  }

  // Debug: Log the data being sent
  console.log('Sending kedatangan update:', {
    id_row: currentKedatanganRow.id_row,
    sheetName: currentKedatanganRow.sheetName,
    status_kehadiran: statusKehadiran,
    catatan: catatan
  });
  
  // Validate data before sending
  if (!currentKedatanganRow.id_row || !currentKedatanganRow.sheetName) {
    alert('Data kendaraan tidak lengkap!');
    return;
  }

  showLoading('Mengupdate status kedatangan...');

  const params = new URLSearchParams();
  params.append("action", "update_kedatangan");
  params.append("id_row", currentKedatanganRow.id_row);
  params.append("sheetName", currentKedatanganRow.sheetName);
  params.append("status_kehadiran", statusKehadiran);
  params.append("catatan", catatan);

  console.log('Sending params:', params.toString());

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => {
      console.log('Response status:', res.status);
      return res.text();
    })
    .then(msg => {
      console.log('Server response:', msg);
      
      if (msg.includes('✅')) {
        alert(msg);
        closeKedatanganModal();
        
        // Immediately reload data to show updated status
        console.log('Reloading data to show updated status...');
        loadData();
      } else {
        alert(msg);
      }
    })
    .catch(err => {
      console.error('Error updating kedatangan:', err);
      alert("Gagal mengupdate status kedatangan: " + err);
    })
    .finally(() => {
      hideLoading();
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('kedatanganModal');
  if (event.target === modal) {
    closeKedatanganModal();
  }
}

window.onload = checkLogin;
</script>
</body>
</html>
